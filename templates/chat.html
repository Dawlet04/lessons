{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="{% static 'chat.css' %}">
</head>
<body>

<div class="app">

    <!-- LEFT: USERS -->
    <aside class="sidebar">
        <div class="sidebar-header">
            üë§ {{ current_user.username }}
            {% if is_admin %}
                <span class="role">ADMIN</span>
            {% endif %}
        </div>

        <ul class="user-list">
            {% for user in other_users %}
                <li class="user-item"
                    data-user-id="{{ user.id }}"
                    data-username="{{ user.username }}">
                    {{ user.username }}
                </li>
            {% empty %}
                <li class="empty">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
            {% endfor %}
        </ul>
    </aside>

    <!-- RIGHT: CHAT -->
    <main class="chat">
        <div class="chat-header">
            <span id="chat-with">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
        </div>

        <div id="chat-log" class="chat-messages"></div>

        <div class="chat-input">
            <input id="chat-message-input"
                   type="text"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   disabled>
            <button id="chat-message-submit" disabled>‚û§</button>
        </div>
    </main>

</div>

<script>
const CURRENT_USER = "{{ current_user.username }}";

let socket = null;
let recipientId = null;

const chatLog = document.getElementById('chat-log');
const input = document.getElementById('chat-message-input');
const submit = document.getElementById('chat-message-submit');
const chatWith = document.getElementById('chat-with');

/* ================= USERS CLICK ================= */

document.querySelectorAll('.user-item').forEach(item => {
    item.onclick = () => {
        recipientId = item.dataset.userId;
        chatWith.textContent = item.dataset.username;

        chatLog.innerHTML = '';
        input.disabled = false;
        submit.disabled = false;

        if (socket) socket.close();

        socket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + recipientId + '/'
        );

        socket.onmessage = e => {
            const data = JSON.parse(e.data);
            addMessage(
                data.message,
                data.sender,
                data.sender === CURRENT_USER
            );
        };

        fetch(`/api/messages/${recipientId}/`)
            .then(res => res.json())
            .then(data => {
                data.messages.forEach(msg => {
                    addMessage(
                        msg.text,
                        msg.sender__username,
                        msg.sender__username === CURRENT_USER
                    );
                });
            });
    };
});

/* ================= SEND ================= */

submit.onclick = sendMessage;
input.addEventListener("keyup", e => {
    if (e.key === "Enter") sendMessage();
});

function sendMessage() {
    if (!socket || socket.readyState !== WebSocket.OPEN) return;
    if (!input.value.trim()) return;

    socket.send(JSON.stringify({
        message: input.value,
        recipient_id: recipientId
    }));

    addMessage(input.value, CURRENT_USER, true);
    input.value = '';
}

/* ================= UI ================= */

function addMessage(text, sender, mine=false) {
    const div = document.createElement('div');
    div.className = mine ? 'message me' : 'message other';

    const name = document.createElement('strong');
    name.innerText = sender;

    const br = document.createElement('br');

    const msg = document.createElement('span');
    msg.innerText = text;

    div.appendChild(name);
    div.appendChild(br);
    div.appendChild(msg);

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}
</script>

</body>
</html>